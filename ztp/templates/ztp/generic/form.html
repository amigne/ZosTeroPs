{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block content_title %}{{ object_description|capfirst }} {% if object.id %}#{{ object.id }} - {% trans 'Edit' %}{% else %}- {% trans 'New' %}{% endif %}{% endblock content_title %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">{{ object_description|capfirst }} {% if object.id %}#{{ object.id }} - {% trans 'Edit' %}{% else %}- {% trans 'New' %}{% endif %}</h3>
                    </div>
                    <form method="post"{% if menu_item == "firmware" %} enctype="multipart/form-data"{% endif %}>
                        {% csrf_token %}
                        {{ formset.management_form }}

                        <p class="error"></p>
                        {% for error in form.non_field_errors %}
                            <p class="error">{{ error }}</p>
                        {% endfor %}
                        {% for error in formset.non_form_errors %}
                            <p class="error">{{ error }}</p>
                        {% endfor %}

                        <div class="card-body update {{ menu_item }}">
                            {% if form.vendor %}
                                <div class="form-group">
                                    {% with field=form.vendor %}
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        <select name="{{ field.name }}"
                                                id="{{ field.id_for_label }}"
                                                class="form-control{% if field.errors %} has-error{% endif %}"
                                                {% if field.field.required %}required{% endif %}>
                                            {% for value, display in form.fields.vendor.choices %}
                                                <option value="{{ value }}"{% if value|stringformat:'s' == field.value|stringformat:'s' %} selected{% endif %}>{{ display }}</option>
                                            {% endfor %}
                                        </select>
                                        {% for error in field.errors %}
                                            <p class="field-error">{{ error }}</p>
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            {% if form.platform %}
                                <div class="form-group">
                                    {% with field=form.platform %}
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        <select name="{{ field.name }}"
                                                id="{{ field.id_for_label }}"
                                                class="form-control{% if field.errors %} has-error{% endif %}"
                                                {% if field.field.required %}required{% endif %}>
                                            {% for value, display in form.fields.platform.choices %}
                                                <option value="{{ value }}"{% if value|stringformat:'s' == field.value|stringformat:'s' %} selected{% endif %}>{{ display }}</option>
                                            {% endfor %}
                                        </select>
                                        {% for error in field.errors %}
                                            <p class="field-error">{{ error }}</p>
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            {% if form.name %}
                                <div class="form-group">
                                    {% with field=form.name %}
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        <input type="text" name="{{ field.name }}"
                                               id="{{ field.id_for_label }}"
                                               class="form-control{% if field.errors %} has-error{% endif %}"
                                               placeholder="{{ field.label|lower }}"
                                               {% if field.field.required %}required{% endif %}
                                               {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                               {% if field.value %}value="{{ field.value }}"{% endif %}>
                                        {% for error in field.errors %}
                                            <p class="field-error">{{ error }}</p>
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            {% if form.file %}
                                <div class="form-group">
                                    {% with field=form.file %}
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {% if field.value %}{% trans 'Currently:' %} {{ field.value }}<br />{% trans 'Change:' %}{% endif %}
                                        <input type="file" name="{{ field.name }}"
                                               id="{{ field.id_for_label }}"
                                               class="form-control{% if field.errors %} has-error{% endif %}"
                                               placeholder="{{ field.label|lower }}"
                                               {% if field.field.required and not field.value %}required{% endif %}
                                               {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                               {% if field.value %}value="{{ field.value }}"{% endif %}>
                                        {% for error in field.errors %}
                                            <p class="field-error">{{ error }}</p>
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            {% if form.description %}
                                <div class="form-group">
                                    {% with field=form.description %}
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        <textarea name="{{ field.name }}"
                                                  id="{{ field.id_for_label }}"
                                                  class="form-control{% if field.errors %} has-error{% endif %}"
                                                  placeholder="{{ field.label|lower }}"
                                                  {% if field.field.required %}required{% endif %}
                                                  {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                                  rows="10"
                                        >{% if field.value %}{{ field.value }}{% endif %}</textarea>
                                        {% for error in field.errors %}
                                            <p class="field-error">{{ error }}</p>
                                        {% endfor %}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            {% if form.platforms %}
                                <div class="form-group">
                                    {% with field=form.platforms %}
                                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                        {{ form.platforms }}
                                    {% endwith %}
                                </div>
                            {% endif %}
                            {% if menu_item == "ztpScript" %}
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {% with field=form.render_template %}
                                            <input type="checkbox" name="{{ field.name }}"
                                                   id="{{ field.id_for_label }}"
                                                   class="custom-control-input{% if field.errors %} has-error{% endif %}"
                                                   {% if field.value %}checked{% endif %}
                                                   {% if field.field.required %}required{% endif %}>
                                            <label for="{{ field.id_for_label }}" class="custom-control-label">{{ field.label }}</label>
                                            {% for error in field.errors %}
                                                <p class="field-error">{{ error }}</p>
                                            {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {% with field=form.use_parameters %}
                                            <input type="checkbox" name="{{ field.name }}"
                                                   id="{{ field.id_for_label }}"
                                                   class="custom-control-input{% if field.errors %} has-error{% endif %}"
                                                   {% if field.value %}checked{% endif %}
                                                   {% if field.field.required %}required{% endif %}>
                                            <label for="{{ field.id_for_label }}" class="custom-control-label">{{ field.label }}</label>
                                            {% for error in field.errors %}
                                                <p class="field-error">{{ error }}</p>
                                            {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {% with field=form.accept_query_string %}
                                            <input type="checkbox" name="{{ field.name }}"
                                                   id="{{ field.id_for_label }}"
                                                   class="custom-control-input{% if field.errors %} has-error{% endif %}"
                                                   {% if field.value %}checked{% endif %}
                                                   {% if field.field.required %}required{% endif %}>
                                            <label for="{{ field.id_for_label }}" class="custom-control-label">{{ field.label }}</label>
                                            {% for error in field.errors %}
                                                <p class="field-error">{{ error }}</p>
                                            {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {% with field=form.priority_query_string_over_arguments %}
                                            <input type="checkbox" name="{{ field.name }}"
                                                   id="{{ field.id_for_label }}"
                                                   class="custom-control-input{% if field.errors %} has-error{% endif %}"
                                                   {% if field.value %}checked{% endif %}
                                                   {% if field.field.required %}required{% endif %}>
                                            <label for="{{ field.id_for_label }}" class="custom-control-label">{{ field.label }}</label>
                                            {% for error in field.errors %}
                                                <p class="field-error">{{ error }}</p>
                                            {% endfor %}
                                        {% endwith %}
                                    </div>
                                </div>
                            {% endif %}
                            {% if formset %}
                                <div class="form-group">
                                    <fieldset id="parameters" style="width:100%;">
                                        {% if menu_item == "ztpScript" %}
                                            <table class="table table-bordered parameters">
                                                <thead>
                                                    <tr>
                                                        <th style="width:50%;">{% trans "Name" %}</th>
                                                        <th style="width:50%;">{% trans "Value" %}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for parameter in formset %}
                                                        <tr class="link-formset">
                                                            <td>
                                                                {% with field=parameter.id %}
                                                                    <input type="hidden" name="{{ parameter.prefix }}-{{ field.name }}"
                                                                           {% if field.value %}value="{{ field.value }}"{% endif %}
                                                                           id="{{ field.id_for_label }}">
                                                                    {% for error in field.errors %}
                                                                        <p class="field-error">{{ error }}</p>
                                                                    {% endfor %}
                                                                {% endwith %}
                                                                {% with field=parameter.name %}
                                                                    <label for="{{ field.id_for_label }}" style="display: none;">{{ field.label }}</label>
                                                                    <input type="text" name="{{ parameter.prefix }}-{{ field.name }}"
                                                                           class="form-control{% if field.errors %} has-error{% endif %}"
                                                                           {% if field.value %}value="{{ field.value }}"{% endif %}
                                                                           {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                                                           id="{{ field.id_for_label }}">
                                                                    {% for error in field.errors %}
                                                                        <p class="field-error">{{ error }}</p>
                                                                    {% endfor %}
                                                                {% endwith %}
                                                            </td>
                                                            <td>
                                                                {% with field=parameter.value %}
                                                                    <label for="{{ field.id_for_label }}" style="display: none;">{{ field.label }}</label>
                                                                    <input type="text" name="{{ parameter.prefix }}-{{ field.name }}"
                                                                           {% if field.value %}value="{{ field.value }}"{% endif %}
                                                                           class="form-control{% if field.errors %} has-error{% endif %}"
                                                                           {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                                                           id="{{ field.id_for_label }}">
                                                                    {% for error in field.errors %}
                                                                        <p class="field-error">{{ error }}</p>
                                                                    {% endfor %}
                                                                {% endwith %}
                                                                {% with field=parameter.DELETE %}
                                                                    <label for="{{ field.id_for_label }}" style="display: none;">{{ field.label }}</label>
                                                                    <input type="hidden" name="{{ parameter.prefix }}-{{ field.name }}"
                                                                           {% if field.value %}value="{{ field.value }}"{% endif %}
                                                                           id="{{ field.id_for_label }}">
                                                                {% endwith %}
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% elif menu_item == "config" %}
                                            {% for parameter in formset %}
                                                <div class="link-formset">
                                                    {% with field=parameter.id %}
                                                        <input type="hidden" name="{{ parameter.prefix }}-{{ field.name }}"
                                                               {% if field.value %}value="{{ field.value }}"{% endif %}
                                                               id="{{ field.id_for_label }}">
                                                    {% endwith %}
                                                    {% with field=parameter.name %}
                                                        <input type="hidden" name="{{ parameter.prefix }}-{{ field.name }}"
                                                               {% if field.value %}value="{{ field.value }}"{% endif %}
                                                               id="{{ field.id_for_label }}">
                                                        {% for error in field.errors %}
                                                            <p class="field-error">{{ error }}</p>
                                                        {% endfor %}
                                                    {% endwith %}
                                                    {% with field=parameter.data %}
                                                        <label for="{{ field.id_for_label }}" class="config_parameter_label" style="display: none;">{{ field.label }}</label>
                                                        <input type="hidden" name="{{ parameter.prefix }}-{{ field.name }}"
                                                               {% if field.value %}value="{{ field.value }}"{% endif %}
                                                               id="{{ field.id_for_label }}">
                                                        <div id="{{ field.id_for_label }}-jstable" class="jstable_instance"></div><br />
                                                        {% for error in field.errors %}
                                                            <p class="field-error">{{ error }}</p>
                                                        {% endfor %}
                                                    {% endwith %}
                                                    <div class="form-group">
                                                        <div class="custom-control custom-switch">
                                                            {% with field=parameter.is_mandatory %}
                                                                <input type="checkbox" name="{{ parameter.prefix }}-{{ field.name }}"
                                                                       id="{{ field.id_for_label }}"
                                                                       class="custom-control-input{% if field.errors %} has-error{% endif %}"
                                                                       {% if field.value %}checked{% endif %}
                                                                       {% if field.field.required %}required{% endif %}>
                                                                <label for="{{ field.id_for_label }}" class="custom-control-label">{{ field.label }}</label>
                                                                {% for error in field.errors %}
                                                                    <p class="field-error">{{ error }}</p>
                                                                {% endfor %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                    {% with field=parameter.DELETE %}
                                                        <label for="{{ field.id_for_label }}" style="display: none;">{{ field.label }}</label>
                                                        <input type="hidden" name="{{ parameter.prefix }}-{{ field.name }}"
                                                            {% if field.value %}value="{{ field.value }}"{% endif %}
                                                            id="{{ field.id_for_label }}">
                                                    {% endwith %}
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </fieldset>
                                </div>
                            {% endif %}
                            {% if form.template %}
                                {% with field=form.template %}
                                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                    <textarea name="{{ field.name }}"
                                              id="{{ field.id_for_label }}"
                                              {% if field.errors %}class="has-error"{% endif %}
                                              placeholder="{{ field.label|lower }}"
                                              {% if field.field.required %}required{% endif %}
                                              {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                    >{% if field.value %}{{ field.value }}{% endif %}</textarea>
                                    {% for error in field.errors %}
                                        <p class="field-error">{{ error }}</p>
                                    {% endfor %}
                                {% endwith %}
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">{% if object.id %}{% trans "Update" %}{% else %}{% trans "Create" %}{% endif %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block css_page %}
    {% if menu_item == "config" %}
        <link rel="stylesheet" href="{% static "ztp/css/jsTable.css" %}" type="text/css" />
        <link rel="stylesheet" href="{% static "ztp/css/jsuites.css" %}" type="text/css" />
    {% endif %}
    {% if form.description %}
        <link rel="stylesheet" href="{% static 'admin-lte/plugins/summernote/summernote-bs4.css' %}">
    {% endif %}
    {% if form.template %}
        <link rel="stylesheet" href="{% static 'admin-lte/plugins/codemirror/codemirror.css' %}">
        <link rel="stylesheet" href="{% static 'admin-lte/plugins/codemirror/theme/monokai.css' %}">
    {% endif %}
{% endblock css_page %}

{% block js_page %}
    {% if menu_item == "ztpScript" or menu_item == "config" %}
        <script src="{% static "ztp/js/jquery.formset.js" %}"></script>
        <script>
            function table_delete_confirmation(id, initial_count) {
                if (id < initial_count) {
                    return confirm('{% trans "You are about to delete the complete table with its pre-existing data. Are you sure you want to continue?" %}');
                }
                return true;
            }

            $(function() {
                $('.link-formset').formset({
                    prefix: 'parameters',
                    {% if menu_item == "config" %}
                        addText: '{% trans "Add Parameter Table" %}',
                        deleteText: '{% trans "Remove Parameter Table" %}',
                        onbeforedelete: table_delete_confirmation,
                    {% else %}
                        addText: '{% trans "Add Parameter" %}',
                        deleteText: '{% trans "Remove Parameter" %}'
                    {% endif %}
                });
            });
        </script>
    {% endif %}
    {% if form.description %}
        <script src="{% static 'admin-lte/plugins/summernote/summernote-bs4.min.js' %}"></script>
        <script>
            $(function () {
                $('#{{ form.description.id_for_label }}').summernote()
            });
        </script>
    {% endif %}
    {% if form.template %}
        <script src="{% static 'admin-lte/plugins/codemirror/codemirror.js' %}"></script>
        <script src="{% static 'admin-lte/plugins/codemirror/mode/css/css.js' %}"></script>
        <script src="{% static 'admin-lte/plugins/codemirror/mode/xml/xml.js' %}"></script>
        <script src="{% static 'admin-lte/plugins/codemirror/mode/htmlmixed/htmlmixed.js' %}"></script>
        <script src="{% static 'admin-lte/plugins/codemirror/mode/python/python.js' %}"></script>
        <script>
            $(function () {
                CodeMirror.fromTextArea(document.getElementById("{{ form.template.id_for_label }}"), {
                    mode: "python",
                    theme: "monokai"
                });
            });
        </script>
    {% endif %}
    {% if menu_item == "config" %}
        <script src="{% static "ztp/js/jsTable.js" %}"></script>
        <script src="{% static "ztp/js/jsuites.js" %}"></script>
        <script>
            function onElementInserted(containerSelector, elementSelector, callback) {
                let onMutationsObserved = function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.addedNodes.length) {
                            let elements = $(mutation.addedNodes).find(elementSelector);
                            for (let i = 0, len = elements.length; i < len; ++i) {
                                callback(elements[i]);
                            }
                        }
                    });
                };

                let target = $(containerSelector)[0];
                let config = { childList: true, subtree: true };
                let MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
                let observer = new MutationObserver(onMutationsObserved);
                observer.observe(target, config);
            }
        </script>
        <script>
            function update_jstable_first_column_header(jstable_obj, title) {
                if (title !== '') {
                    jstable_obj.setHeader(0, title);
                }
            }

            function isEmptyData(data) {
                for (let i = 0; i < data.length; ++i) {
                    for (let j = 0; j < data[i].length; ++j) {
                        if (data[i][j] !== '') {
                            return false;
                        }
                    }
                }
                return true;
            }

            function areInitialColumnsTitles(columns) {
                for (let i = 0; i < columns.length; ++i) {
                    let columnName = 'title' in columns[i] ? columns[i]['title'] : '';
                    if (columnName !== jsTable.getColumnName(i)) {
                        return false;
                    }
                }
                return true;
            }

            function getFirstColumnTitle(columns) {
                if (columns.length > 0 && 'title' in columns[0]) {
                    return columns[0]['title'];
                }
                return '';
            }

            function load_jstable_data(spreadsheet_id) {
                let data_id = spreadsheet_id.replace(/-jstable$/, '');
                let name_id = data_id.replace(/-[^-]*$/, '') + '-name';

                let data_element = $('#' + data_id);
                let name_element = $('#' + name_id);

                let data_value = data_element.val();
                let width = document.getElementById('parameters').clientWidth;
                let options = {
                    minDimensions: [2, 1],
                    defaultColWidth: 120,
                    tableOverflow: true,
                    tableWidth: width + 'px',
                    freezeColumns: 1,
                };
                if (data_value !== '') {
                    try {
                        let data_hash = JSON.parse(data_value);
                        let data_lines = data_hash['data'].length
                        options['minDimensions'] = [2, data_lines + 1];
                        options = Object.assign({}, options, data_hash);
                    } catch (e) {}
                }

                let jstable_obj = jsTable(document.getElementById(spreadsheet_id), options);
                let name_value = name_element.val();
                update_jstable_first_column_header(jstable_obj, name_value);

                name_element.keyup(function(){
                    let name_value = name_element.val();
                    if (name_value === '') {
                        name_element.val(jstable_obj.getHeader(0).substring(0,1));
                    }
                    update_jstable_first_column_header(jstable_obj, name_value);
                });

                return jstable_obj;
            }

            function findDuplicates(dict) {
                let hash = Object.create(null);
                let result = Object.create(null);

                Object.keys(dict).forEach(k => {
                    let grp = dict[k];
                    (grp in hash) ? hash[grp].push(k): (hash[grp] = [k]);
                });

                for (let key in hash) {
                    if (hash[key].length > 1) {
                        result[key] = hash[key].toString();
                    }
                }

                return result
            }

            function save_jstable_data(jstable_instances) {
                let names = {};

                for (let spreadsheet_id in jstable_instances) {
                    let jstable_instance = jstable_instances[spreadsheet_id];

                    let data_id = spreadsheet_id.replace(/-jstable$/, '');
                    let name_id = data_id.replace(/-[^-]*$/, '') + '-name';

                    let data_element = $('#' + data_id);
                    let name_element = $('#' + name_id);

                    let table_data = jstable_instance.getData();
                    let table_columns = jstable_instance.getColumnsProperties();
                    let isSet = (! areInitialColumnsTitles(table_columns)) || (! isEmptyData(table_data));

                    // Remove empty data line
                    let new_table_data = []
                    for (let i = 0; i < table_data.length; ++i) {
                        let empty = true;
                        for (let j = 0; j < table_data[i].length; ++j) {
                            if (table_data[i][j]) {
                                empty = false;
                                break
                            }
                        }
                        if (! empty) {
                            new_table_data.push(table_data[i]);
                        }
                    }
                    table_data = new_table_data

                    if (isSet) {
                        name_element.val(getFirstColumnTitle(table_columns));
                        data_element.val(JSON.stringify({
                            data: table_data,
                            columns: table_columns,
                        }));
                        names[spreadsheet_id] = getFirstColumnTitle(table_columns);
                    } else {
                        name_element.val('');
                        data_element.val('');
                    }
                }
                let duplicates = findDuplicates(names);
                if (Object.keys(duplicates).length > 0) {
                    for (let key in duplicates) {
                        $('.error').first().text('Duplicate key "' + key + '" found for parameters.');
                    }
                    return false;
                }

                return true;
            }
        </script>
        <script>
            let jstable_objs = {};

            $(function() {
                let stylesheet_id;
                {% for parameter in formset %}
                    stylesheet_id = '{{ parameter.data.id_for_label }}-jstable';
                    jstable_objs[stylesheet_id] = load_jstable_data(stylesheet_id);
                {% endfor %}

                onElementInserted('body', '.jstable_instance', function (element) {
                    stylesheet_id = element.id;
                    jstable_objs[stylesheet_id] = load_jstable_data(stylesheet_id);
                });

                $("form").submit(function () {
                     return save_jstable_data(jstable_objs);
                });
            })
        </script>
    {% endif %}
{% endblock js_page %}
